stages:
  - validate

validate_conf_files:
  stage: validate
  tags:
    - shell-runner
  rules:
    - changes:
        - "**/*.conf"
      when: always
    - when: never
  script:
    - echo "ğŸ” Verificando arquivos .conf modificados em relaÃ§Ã£o Ã  branch develop..."
    - git fetch origin develop
    - |
      MODIFIED_FILES=$(git diff --name-only origin/develop...HEAD | grep '\.conf$' || true)

      if [ -z "$MODIFIED_FILES" ]; then
        echo "âœ… Nenhum arquivo .conf modificado. Nada para validar."
        exit 0
      fi

      echo "ğŸ“„ Arquivos .conf modificados:"
      echo "$MODIFIED_FILES"

      STATUS=0

      for file in $MODIFIED_FILES; do
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§ª Validando arquivo: $file"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        VALIDATION_OUTPUT=$(logstash --config.test_and_exit -f "$file" 2>&1)

        if [ $? -ne 0 ]; then
          echo "âŒ Erro de validaÃ§Ã£o no arquivo: $file"
          echo "ğŸ” Detalhes do erro:"
          echo "$VALIDATION_OUTPUT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          STATUS=1
        else
          echo "âœ… Arquivo validado com sucesso: $file"
        fi
      done

      exit $STATUS
